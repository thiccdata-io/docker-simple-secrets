<div class="password-store-section">
  <div class="section-header">
    <h3>Services & Secrets</h3>
    <div class="header-actions">
      <button 
        id="deploy-button"
        class="btn btn-small btn-deploy"
        hx-post="/deploy"
        hx-target="#services-list"
        hx-swap="outerHTML"
        hx-disabled-elt="this">
        <span class="btn-text">üöÄ Deploy</span>
        <span class="btn-loader" style="display: none;">‚è≥ Deploying...</span>
      </button>
      <button 
        class="btn btn-small"
        onclick="document.getElementById('new-service-form').style.display='block'">
        + New Service
      </button>
    </div>
  </div>

  <div class="search-section">
    <input 
      type="text" 
      id="secret-search" 
      placeholder="Search secrets... (use service/ to filter by service)" 
      class="input search-input"
      oninput="filterSecrets(this.value)" />
  </div>

  <div id="new-service-form" class="form-section" style="display: none;">
    <form hx-post="/services" hx-target="#services-list" hx-swap="innerHTML" hx-on::after-request="this.reset(); this.parentElement.style.display='none'">
      <input 
        type="text" 
        name="serviceName" 
        placeholder="Service name (e.g., 'database')" 
        required
        class="input" />
      <button type="submit" class="btn btn-primary">Create Service</button>
      <button type="button" class="btn btn-secondary" onclick="this.parentElement.parentElement.style.display='none'">Cancel</button>
    </form>
  </div>

  <div id="services-list">
    <%- include('services_list', { services: services }) %>
  </div>
</div>

<script>
function filterSecrets(searchTerm) {
  const term = searchTerm.toLowerCase().trim();
  const serviceItems = document.querySelectorAll('.service-item');
  
  // Check if search is service-specific (e.g., "myservice/")
  const serviceMatch = term.match(/^([a-zA-Z0-9_-]+)\/(.*)$/);
  
  if (serviceMatch) {
    // Service-specific search: service-name/secret-filter
    const [, serviceName, secretFilter] = serviceMatch;
    
    serviceItems.forEach(serviceItem => {
      const serviceNameElement = serviceItem.querySelector('.service-name-text');
      const itemServiceName = serviceNameElement ? serviceNameElement.textContent.toLowerCase() : '';
      
      if (itemServiceName.includes(serviceName)) {
        // Show this service
        serviceItem.style.display = '';
        
        if (secretFilter) {
          // Filter secrets within this service
          const secretItems = serviceItem.querySelectorAll('.secret-item');
          secretItems.forEach(secretItem => {
            const secretNameBtn = secretItem.querySelector('.secret-name-btn');
            const secretName = secretNameBtn ? secretNameBtn.textContent.toLowerCase() : '';
            secretItem.style.display = secretName.includes(secretFilter) ? '' : 'none';
          });
        } else {
          // Show all secrets in this service
          const secretItems = serviceItem.querySelectorAll('.secret-item');
          secretItems.forEach(secretItem => {
            secretItem.style.display = '';
          });
        }
      } else {
        // Hide this service
        serviceItem.style.display = 'none';
      }
    });
  } else if (term) {
    // Fuzzy search across all services and secrets
    serviceItems.forEach(serviceItem => {
      const serviceNameElement = serviceItem.querySelector('.service-name-text');
      const serviceName = serviceNameElement ? serviceNameElement.textContent.toLowerCase() : '';
      const secretItems = serviceItem.querySelectorAll('.secret-item');
      
      let hasVisibleSecrets = false;
      
      secretItems.forEach(secretItem => {
        const secretNameBtn = secretItem.querySelector('.secret-name-btn');
        const secretName = secretNameBtn ? secretNameBtn.textContent.toLowerCase() : '';
        const fullPath = `${serviceName}/${secretName}`;
        
        // Fuzzy match: check if all characters in search term appear in order
        const matches = fuzzyMatch(fullPath, term) || secretName.includes(term) || serviceName.includes(term);
        
        if (matches) {
          secretItem.style.display = '';
          hasVisibleSecrets = true;
        } else {
          secretItem.style.display = 'none';
        }
      });
      
      // Show service if it has visible secrets or matches the search
      serviceItem.style.display = (hasVisibleSecrets || serviceName.includes(term)) ? '' : 'none';
    });
  } else {
    // No search term - show everything
    serviceItems.forEach(serviceItem => {
      serviceItem.style.display = '';
      const secretItems = serviceItem.querySelectorAll('.secret-item');
      secretItems.forEach(secretItem => {
        secretItem.style.display = '';
      });
    });
  }
}

// Fuzzy matching: checks if all characters in needle appear in haystack in order
function fuzzyMatch(haystack, needle) {
  let haystackIndex = 0;
  let needleIndex = 0;
  
  while (haystackIndex < haystack.length && needleIndex < needle.length) {
    if (haystack[haystackIndex] === needle[needleIndex]) {
      needleIndex++;
    }
    haystackIndex++;
  }
  
  return needleIndex === needle.length;
}

// Handle loading states for buttons
document.body.addEventListener('htmx:beforeRequest', function(event) {
  // Check if it's triggered by a button (direct or via form submission)
  let button = event.detail.elt;
  
  // If the element is a form, find the submit button that triggered it
  if (button.tagName === 'FORM') {
    const submitButton = event.detail.triggeringEvent?.submitter;
    if (submitButton) {
      button = submitButton;
    }
  }
  
  if (button.tagName === 'BUTTON') {
    const textSpan = button.querySelector('.btn-text');
    const loaderSpan = button.querySelector('.btn-loader');
    if (textSpan && loaderSpan) {
      textSpan.style.display = 'none';
      loaderSpan.style.display = 'inline';
      button.disabled = true;
      button.style.opacity = '0.6';
      button.style.cursor = 'not-allowed';
    }
  }
});

document.body.addEventListener('htmx:afterRequest', function(event) {
  // Check if it's triggered by a button (direct or via form submission)
  let button = event.detail.elt;
  
  // If the element is a form, find the submit button that triggered it
  if (button.tagName === 'FORM') {
    const submitButton = event.detail.triggeringEvent?.submitter;
    if (submitButton) {
      button = submitButton;
    }
  }
  
  if (button.tagName === 'BUTTON') {
    const textSpan = button.querySelector('.btn-text');
    const loaderSpan = button.querySelector('.btn-loader');
    if (textSpan && loaderSpan) {
      textSpan.style.display = 'inline';
      loaderSpan.style.display = 'none';
      button.disabled = false;
      button.style.opacity = '1';
      button.style.cursor = 'pointer';
    }
  }
});
</script>
